From 19d71c4bea80f0940e17bf06d0ec4cfe7fe4006d Mon Sep 17 00:00:00 2001
From: Milan Schmittner <mschmittner@seemoo.tu-darmstadt.de>
Date: Wed, 11 Jan 2017 13:50:15 +0100
Subject: [PATCH] Revert "On ancient Linux kernels, block on /dev/random before
 using /dev/urandom"

This reverts commit c752eb55d9e9992bc38e7790128953427aa0a89f.
---
 .../salsa20/randombytes_salsa20_random.c           | 33 ----------------------
 .../randombytes/sysrandom/randombytes_sysrandom.c  | 33 ----------------------
 2 files changed, 66 deletions(-)

diff --git a/src/libsodium/randombytes/salsa20/randombytes_salsa20_random.c b/src/libsodium/randombytes/salsa20/randombytes_salsa20_random.c
index 2d21472..b55b5bd 100644
--- a/src/libsodium/randombytes/salsa20/randombytes_salsa20_random.c
+++ b/src/libsodium/randombytes/salsa20/randombytes_salsa20_random.c
@@ -7,7 +7,6 @@
 #endif
 #ifdef __linux__
 # include <sys/syscall.h>
-# include <poll.h>
 #endif
 
 #include <assert.h>
@@ -130,33 +129,6 @@ safe_read(const int fd, void * const buf_, size_t size)
 #endif
 
 #ifndef _WIN32
-# if defined(__linux__) && !defined(USE_BLOCKING_RANDOM)
-static int
-randombytes_block_on_dev_random(void)
-{
-    struct pollfd pfd;
-    int           fd;
-    int           pret;
-
-    fd = open("/dev/random", O_RDONLY);
-    if (fd == -1) {
-        return 0;
-    }
-    pfd.fd = fd;
-    pfd.events = POLLIN;
-    pfd.revents = 0;
-    do {
-        pret = poll(&pfd, 1, -1);
-    } while (pret < 0 && (errno == EINTR || errno == EAGAIN));
-    if (pret != 1) {
-        (void) close(fd);
-        errno = EIO;
-        return -1;
-    }
-    return close(fd);
-}
-# endif
-
 # ifndef HAVE_SAFE_ARC4RANDOM
 static int
 randombytes_salsa20_random_random_dev_open(void)
@@ -172,11 +144,6 @@ randombytes_salsa20_random_random_dev_open(void)
     const char **     device = devices;
     int               fd;
 
-# if defined(__linux__) && !defined(USE_BLOCKING_RANDOM)
-    if (randombytes_block_on_dev_random() != 0) {
-        return -1;
-    }
-# endif
     do {
         fd = open(*device, O_RDONLY);
         if (fd != -1) {
diff --git a/src/libsodium/randombytes/sysrandom/randombytes_sysrandom.c b/src/libsodium/randombytes/sysrandom/randombytes_sysrandom.c
index 6410cf8..b0d10e1 100644
--- a/src/libsodium/randombytes/sysrandom/randombytes_sysrandom.c
+++ b/src/libsodium/randombytes/sysrandom/randombytes_sysrandom.c
@@ -7,7 +7,6 @@
 #endif
 #ifdef __linux__
 # include <sys/syscall.h>
-# include <poll.h>
 #endif
 
 #include <assert.h>
@@ -114,33 +113,6 @@ safe_read(const int fd, void * const buf_, size_t size)
 #endif
 
 #ifndef _WIN32
-# if defined(__linux__) && !defined(USE_BLOCKING_RANDOM)
-static int
-randombytes_block_on_dev_random(void)
-{
-    struct pollfd pfd;
-    int           fd;
-    int           pret;
-
-    fd = open("/dev/random", O_RDONLY);
-    if (fd == -1) {
-        return 0;
-    }
-    pfd.fd = fd;
-    pfd.events = POLLIN;
-    pfd.revents = 0;
-    do {
-        pret = poll(&pfd, 1, -1);
-    } while (pret < 0 && (errno == EINTR || errno == EAGAIN));
-    if (pret != 1) {
-        (void) close(fd);
-        errno = EIO;
-        return -1;
-    }
-    return close(fd);
-}
-# endif
-
 static int
 randombytes_sysrandom_random_dev_open(void)
 {
@@ -155,11 +127,6 @@ randombytes_sysrandom_random_dev_open(void)
     const char **      device = devices;
     int                fd;
 
-# if defined(__linux__) && !defined(USE_BLOCKING_RANDOM)
-    if (randombytes_block_on_dev_random() != 0) {
-        return -1;
-    }
-# endif
     do {
         fd = open(*device, O_RDONLY);
         if (fd != -1) {
-- 
2.10.1 (Apple Git-78)

